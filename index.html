<!DOCTYPE html>
<html lang="en">





    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
          <link rel="stylesheet" href="css/style.css">

    </head>

    <style>
        #timeSilder {
            /* background-color: yellow; */
            width: 700px;

        }
        .subunit-label {
            fill: #777;
            fill-opacity: .5;
            font-size: 20px;
            font-weight: 300;
            text-anchor: middle;
        }
        body{
            width:1200px;
            margin:100px auto;
        }
        svg text{
            font-size:12px;
        }
        rect{
            shape-rendering:crispEdges;
        }
    </style>



    <body>

    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="//datamaps.github.io/scripts/datamaps.all.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="biPartite.js"></script>
    <div>
        <div id = "timeSilder">
          <label for="nRadius" 
            style="display: inline-block; width: 240px; text-align: right">
             Found from <span id="nRadius-value">1990</span>
          </label>
         <input type="range" value = "1990" min="1980" max="2015" id="nRadius">
        </div>

        <div id="container" style="position: relative; width: 1024px; height: 600px;"></div>
        <img src="color legend.png" alt="Mountain View" style="width:400px;height:100px;">
    </div>

    <script>

    d3.csv("company3.csv", function(error, csv) {

        var dataset = {};
        var colorSet = {};
        var indata;
        
        indata = csv;

         indata=d3.nest()
        .key(function(d) {return d.state_code;})
        .rollup(function(d) {return {
            "length": d.length, "totalFunding_State": d3.sum(d, function(g) {
                return g.funding_total_usd;
            })
        }})
        .entries(indata);

        var onlyValues = indata.map(function(obj){ return obj.values.length; });
        
        var minValue = Math.min.apply(null, onlyValues),
            maxValue = Math.max.apply(null, onlyValues);

        var paletteScale = d3.scale.log()
            .domain([minValue,maxValue])
            .range(["#feb24c","#800026"]);


        indata.forEach(function(item){ //
        // item example value ["USA", 70]
            var iso = item.key,
                value = item.values.length,
                fundingTotal = item.values.totalFunding_State;
            dataset[iso] = { numberOfThings: value, fillKey: paletteScale(value),
                            totalOfThings: fundingTotal };
            colorSet[paletteScale(value)] = paletteScale(value);
        });   


        
        
        //manipulate data
          

        var map = new Datamap({
            element: document.getElementById('container'),
            scope: 'usa',
            fills: colorSet,
            // fills: { defaultFill: '#F5F5F5'},
            data: dataset,
            geographyConfig: {
                borderColor: '#DEDEDE',
                highlightBorderWidth: 2,
                // don't change color on mouse hover
                highlightFillColor: function(geo) {
                    return geo['fillKey'] || '#addd8e';
                },
                // only change border
                highlightBorderColor: '#B7B7B7',
                // show desired information in tooltip
                popupTemplate: function(geo, data) {
                    // don't show tooltip if country don't present in dataset
                    if (!data) { return ; }
                    // tooltip content
                    return ['<div class="hoverinfo">',
                        '<strong>', geo.properties.name, '</strong>',
                        '<br>Number of Startups: <strong>', data.numberOfThings, '</strong>',
                        '<br>Total Fundings: <strong>', data.totalOfThings, '</strong>',
                        '</div>'].join('');
                }
            }

        });



        //time slide bar on call
       d3.select("#nRadius").on("input", function() {
            var year = +this.value;
             d3.select("#nRadius-value").text(+this.value);
             
             indata = csv.filter(filterData);

            function filterData(datum) {
                return +datum["founded_year"] >= year;
            }

             indata=d3.nest()
            .key(function(d) {return d.state_code;})
            .entries(indata);

            indata.forEach(function(item){ //
            // item example value ["USA", 70]
                var iso = item.key,
                    value = item.values.length;
                dataset[iso] = { numberOfThings: value, fillKey: paletteScale(value) };
                colorSet[paletteScale(value)] = paletteScale(value);
            });   

            map.updateChoropleth(dataset);
        });

    })
    </script>

    <script>
        var sales_data=[
        ['Lite','CA',16,0],
        ['Small','CA',1278,4],
        ['Medium','CA',27,0],
        ['Plus','CA',58,0],
        ['Grand','CA',1551,15],
        ['Elite','CA',141,0],
        ['Lite','AZ',5453,35],
        ['Small','AZ',683,1],
        ['Medium','AZ',862,0],
        ['Grand','AZ',6228,30],
        ['Lite','AL',15001,449],
        ['Small','AL',527,3],
        ['Medium','AL',836,0],
        ['Plus','AL',28648,1419],
        ['Grand','AL',3,0],
        ['Lite','CO',13,0],
        ['Small','CO',396,0],
        ['Medium','CO',362,0],
        ['Plus','CO',78,10],
        ['Grand','CO',2473,32],
        ['Elite','CO',2063,64],
        ['Medium','DE',203,0],
        ['Grand','DE',686,2],
        ['Elite','DE',826,0],
        ['Lite','KS',1738,110],
        ['Small','KS',12925,13],
        ['Medium','KS',15413,0],
        ['Small','GA',2166,2],
        ['Medium','GA',86,0],
        ['Plus','GA',348,3],
        ['Grand','GA',4244,18],
        ['Elite','GA',1536,1],
        ['Small','IA',351,0],
        ['Grand','IA',405,1],
        ['Small','IL',914,1],
        ['Medium','IL',127,0],
        ['Grand','IL',1470,7],
        ['Elite','IL',516,1],
        ['Lite','IN',43,0],
        ['Small','IN',667,1],
        ['Medium','IN',172,0],
        ['Plus','IN',149,1],
        ['Grand','IN',1380,5],
        ['Elite','IN',791,23],
        ['Small','FL',1,0],
        ['Grand','FL',1,0],
        ['Small','MD',1070,1],
        ['Grand','MD',1171,2],
        ['Elite','MD',33,0],
        ['Plus','TX',1,0],
        ['Small','MS',407,0],
        ['Medium','MS',3,0],
        ['Grand','MS',457,2],
        ['Elite','MS',20,0],
        ['Small','NC',557,0],
        ['Medium','NC',167,0],
        ['Plus','NC',95,1],
        ['Grand','NC',1090,5],
        ['Elite','NC',676,6],
        ['Lite','NM',1195,99],
        ['Small','NM',350,3],
        ['Medium','NM',212,0],
        ['Grand','NM',1509,8],
        ['Lite','NV',3899,389],
        ['Small','NV',147,0],
        ['Medium','NV',455,0],
        ['Plus','NV',1,1],
        ['Grand','NV',4100,16],
        ['Lite','OH',12,0],
        ['Small','OH',634,2],
        ['Medium','OH',749,0],
        ['Plus','OH',119,1],
        ['Grand','OH',3705,19],
        ['Elite','OH',3456,25],
        ['Small','PA',828,2],
        ['Medium','PA',288,0],
        ['Plus','PA',141,0],
        ['Grand','PA',2625,7],
        ['Elite','PA',1920,10],
        ['Small','SC',1146,2],
        ['Medium','SC',212,0],
        ['Plus','SC',223,4],
        ['Grand','SC',1803,6],
        ['Elite','SC',761,8],
        ['Small','TN',527,0],
        ['Medium','TN',90,0],
        ['Grand','TN',930,4],
        ['Elite','TN',395,1],
        ['Lite','ME',7232,58],
        ['Small','ME',1272,0],
        ['Medium','ME',1896,0],
        ['Plus','ME',1,0],
        ['Grand','ME',10782,33],
        ['Elite','ME',1911,3],
        ['Small','VA',495,0],
        ['Medium','VA',32,0],
        ['Plus','VA',7,0],
        ['Grand','VA',1557,12],
        ['Elite','VA',24,0],
        ['Small','WA',460,1],
        ['Plus','WA',88,3],
        ['Grand','WA',956,3],
        ['Small','WV',232,0],
        ['Medium','WV',71,0],
        ['Grand','WV',575,2],
        ['Elite','WV',368,3]
        ];

        var width = 1100, height = 610, margin ={b:0, t:40, l:170, r:50};

        var svg = d3.select("body")
            .append("svg").attr('width',width).attr('height',(height+margin.b+margin.t))
            .append("g").attr("transform","translate("+ margin.l+","+margin.t+")");

        var data = [ 
            {data:bP.partData(sales_data,2), id:'SalesAttempts', header:["Market","State", "Company by Market"]}
        ];

        bP.draw(data, svg);

    </script>
    </body>
</html>