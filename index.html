<!DOCTYPE html>
<html>
<meta charset="utf-8">
<link rel = "stylesheet" href = "styles.css">


<body>

    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.6.0/d3-legend.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.6.0/d3-legend.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="//datamaps.github.io/scripts/datamaps.all.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="biPartite.js"></script>


    <div>

        <div id="header" style = "background-color:grey;
                                    color:white;
                                    clear:both;
                                    text-align:center;
                                    padding:5px;">
            <h1>Startups Ecosystem</h1>
            
        </div>

        


        <div id = "timeSilder" style = "width: 320px; border: 2px solid grey;
                    padding:25px">
          <label for="nRadius" 
            style="display: inline-block; width: 120px; text-align: left">
             Found from <span id="nRadius-value">1990</span>
          </label>

         <input type="range" value = "1990" min="1980" max="2015" id="nRadius">

         <p>&nbsp; 

         <svg height="30" width="400">
            <defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color: #feb24c;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#800026;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect width="300" height="30" fill="url(#grad1)" padding = "25px"/>
        </svg>
        
        <div>
            <span style = "padding-right: 1em">15</span>
            <span style = "padding-right: 1em">50</span>
            <span style = "padding-right: 1em">100</span>
            <span style = "padding-right: 1em">250</span>
            <span style = "padding-right: 1em">700</span>
            <span style = "padding-right: 1.5em">1500</span>10000
        </div>
        

        </div>

        <div id="container" style="position: relative; width: 1024px; height: 600px;"></div>

    </div>

    <script>



    d3.csv("Funding.csv", function(error, csv) {

        var dataset = {};
        var colorSet = {};
        var indata;
        
        indata = csv;

         indata=d3.nest()
        .key(function(d) {return d.state_code;})
        .rollup(function(d) {return {
            "length": d.length, "total_funding": d3.sum(d, function(g) {
                return parseInt(g.funding_total_usd);
            })
        }})
        .entries(indata);

        var onlyValues = indata.map(function(obj){ return obj.values.length; });
        
        var minValue = Math.min.apply(null, onlyValues),
            maxValue = Math.max.apply(null, onlyValues);

        var paletteScale = d3.scale.log()
            .domain([minValue,maxValue])
            .range(["#feb24c","#800026"]);


        indata.forEach(function(item){ //
        // item example value ["USA", 70]
            var iso = item.key,
                value = item.values.length,
                fundingTotal = item.values.total_funding;
            dataset[iso] = { numberOfThings: value, fillKey: paletteScale(value),
                            totalOfThings: fundingTotal };
            colorSet[paletteScale(value)] = paletteScale(value);
        });
        
        
        //manipulate data
          

        var map = new Datamap({
            element: document.getElementById('container'),
            scope: 'usa',
            fills: colorSet,
            // fills: { defaultFill: '#F5F5F5'},
            data: dataset,
            geographyConfig: {
                borderColor: '#DEDEDE',
                highlightBorderWidth: 4,
                // don't change color on mouse hover
                // highlightFillColor: function(geo) {
                //     return geo['fillKey'] || '#addd8e';
                // },
                // only change border
                highlightBorderColor: '#FFFFFF',
                

                // show desired information in tooltip
                popupTemplate: function(geo, data) {
                    // don't show tooltip if country don't present in dataset
                    if (!data) { return ; }
                    // tooltip content
                    return ['<div class="hoverinfo">',
                        '<strong>', geo.properties.name, '</strong>',
                        '<br>Number of Startups: <strong>', data.numberOfThings, '</strong>',
                        '<br>Total Fundings: <strong>', data.totalOfThings, '</strong>',
                        '</div>'].join('');
                }
            }

        });

        



        //time slide bar on call
       d3.select("#nRadius").on("input", function() {
            var year = +this.value;
             d3.select("#nRadius-value").text(+this.value);
             
             indata = csv.filter(filterData);

            function filterData(datum) {
                return +datum["founded_year"] >= year;
            }

             indata=d3.nest()
            .key(function(d) {return d.state_code;})
            .rollup(function(d) {return {
                "length": d.length, "total_funding": d3.sum(d, function(g) {
                    return parseFloat(g.funding_total_usd);
                })
            }})
            .entries(indata);

            indata.forEach(function(item){ //
            // item example value ["USA", 70]
                var iso = item.key,
                    value = item.values.length,
                    fundingTotal = item.values.total_funding;
                dataset[iso] = { numberOfThings: value, fillKey: paletteScale(value),
                            totalOfThings: fundingTotal };
                colorSet[paletteScale(value)] = paletteScale(value);
            });   

            map.updateChoropleth(dataset);
        });

    })
    </script>

    <script>
        d3.csv("Market_Updated.csv", function(error, csv) {
            var indata = [];
            var i = 0;
            csv.forEach(function(item) {
                indata[i] = [csv[i]["Market"], csv[i]["state_code"], +csv[i]["Count_of_market"], 0];
                i++;
            })
            console.log(indata);
            console.log(i);
            var width = 1100, height = 610, margin ={b:0, t:40, l:170, r:50};

            var svg = d3.select("body")
                .append("svg").attr('width',width).attr('height',(height+margin.b+margin.t))
                .append("g").attr("transform","translate("+ margin.l+","+margin.t+")");

            var data = [ 
                {data:bP.partData(indata,2), id:'SalesAttempts', header:["Market","State", "Company by Market"]}
            ];

            bP.draw(data, svg);
        })   
    </script>
    </body>
</html>